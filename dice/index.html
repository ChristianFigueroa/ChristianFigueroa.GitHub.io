<!DOCTYPE html>
<html lang="en">
<head>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0"/>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>Die Roller &#183; Create, Edit, and Save Custom Dice Rolls</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/dice/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/dice/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/dice/favicon-16x16.png">
    <link rel="manifest" href="/dice/site.webmanifest">
    <link rel="mask-icon" href="/dice/safari-pinned-tab.svg" color="#00aba9">
    <link rel="shortcut icon" href="/dice/favicon.ico">
    <meta name="apple-mobile-web-app-title" content="Die Roller">
    <meta name="application-name" content="Die Roller">
    <meta name="msapplication-TileColor" content="#00aba9">
    <meta name="msapplication-config" content="/dice/browserconfig.xml">
    <meta name="theme-color" content="#fafafa">
    <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-91403443-1', 'auto');
        ga('send', 'pageview');</script>
    <link href="https://fonts.googleapis.com/css?family=Metamorphous|Philosopher|Share+Tech+Mono:400,400i" rel="stylesheet" type="text/css">
    <style>
        html, body {
            margin: 0;
            overflow-y: hidden;
        }

        #main {
            height: 100vh;
            width: 100%;
            font-size: 0;
            display: flex;
        }

        #main > * {
            font-size: initial;
            font-family: Metamorphous, sans-serif;
        }

        #left,
        #right {
            position: relative;
            width: 50%;
            height: 100%;
            display: inline-block;
        }

        #left {
            padding: 1.5em 1em 1.5em;
            width: calc(50% - 2em);
            height: calc(100% - 3em);
            overflow-y: auto;
            overflow-x: hidden;
        }

        .theme_light #left {
            background: #FFF;
        }

        .theme_dark #left {
            background: #234;
        }

        .theme_light #right {
            box-shadow: 0 0 0 1px #000;
        }

        .theme_dark #right {
            box-shadow: 0 0 0 1px #FFF;
        }

        #history,
        #custom,
        #inputSymbol {
            font-family: "Share Tech Mono", Consolas, Monaco, Andale Mono, "Courier New", Courier, monospace;
        }

        #history {
            height: calc(75vh - .8em);
            max-height: calc(100% - 4.8em - 1px);
            font-size: 1.25em;
            overflow-y: auto;
            padding: .4em 0;
            position: relative;
            color: inherit;
        }

        #history > div {
            padding: .25em .4em .25em calc(.4em + 1ch);
            cursor: default;
            clear: right;
            position: relative;
        }

        #custom {
            min-height: 3.6em;
            height: calc(100% - .4em);
            border: 0;
            min-width: calc(100% - .8em - 1ch);
            font-size: 1em;
            padding: .2em .4em .2em calc(.4em + 1ch);
            white-space: pre;
            tab-size: 4;
        }

        #inputSymbol {
            position: absolute;
        }

        #inputSymbol div {
            position: relative;
            top: .2em;
            left: .2em;
            font-weight: bold;
            pointer-events: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #customContainer {
            position: relative;
            min-height: 3.6em;
            height: calc(25vh - 1px);
            width: 100%;
            border-width: 1px 0 0 0;
            border-style: solid;
            font-size: 1.25em;
            overflow-x: auto;
            overflow-y: hidden;
        }

        span.ws_sp,
        span.ws_tb {
            display: inline-block;
            white-space: pre;
        }

        span.ws_sp {
            width: 1ch;
        }

        span.ws_tb {
            width: 4ch;
        }

        span.ws_sp:before {
            content: "·";
            position: absolute;
        }

        span.ws_tb:before {
            content: "····";
            position: absolute;
        }

        .roll_flex {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            flex-grow: 1;
        }

        #general_rolls {
            font-family: "Share Tech Mono", Consolas, Monaco, Andale Mono, "Courier New", Courier, monospace;
            font-size: 1.25em;
            text-align: center;
            margin: 0 -0.25em -.7em;
        }

        .roll_btn {
            font-size: 1em;
            padding: .3em;
        }

        #general_rolls .roll_btn {
            margin: 0 .25em .5em;
            flex-grow: 1;
            min-width: 3em;
        }

        button,
        select {
            cursor: pointer;
            font-family: inherit;
            font-size: 1em;
            position: relative;
            outline: 0;
        }

        button,
        select,
        .save .context_menu {
            border-radius: .25em;
            border-style: solid;
            border-width: 1px;
        }

        .theme_light button,
        .theme_light select,
        .theme_light .extra_menu:active,
        .theme_light .save .context_menu,
        .theme_light #settings:active {
            color: #345;
            background: #FFF;
            border-color: #DDD;
        }

        .theme_light button:hover,
        .theme_light button:focus,
        .theme_light select:hover,
        .theme_light select:focus,
        .theme_light .extra_menu:active,
        .theme_light #settings:active {
            background-color: #F0F0F0;
        }

        .theme_dark button,
        .theme_dark select,
        .theme_dark .extra_menu:active,
        .theme_dark .save .context_menu,
        .theme_dark #settings:active {
            color: #FFF;
            background: #234;
            border-color: #567;
        }

        .theme_dark button:hover,
        .theme_dark button:focus,
        .theme_dark select:hover,
        .theme_dark select:focus,
        .theme_dark .extra_menu:active,
        .theme_dark #settings:active {
            background-color: #456;
        }

        .theme_light button:active,
        .theme_dark button:active,
        button.main {
            background-color: #03A9D4;
            border-color: #0288D1;
            color: #FFF;
        }

        button.main:hover,
        button.main:focus,
        button.main:active {
            background-color: #0288D1;
            border-color: #1565C0;
        }

        .theme_light button.main[disabled] {
            background-color: #B3E5FC;
            border-color: #64B5F6;
        }

        .theme_dark button.main[disabled] {
            background-color: #136E8C;
            color: #DDD;
            border-color: #3482A8;
        }

        .section_header {
            font-size: 1.5em;
            line-height: 1;
            margin-bottom: .5em;
            display: inline-block;
            width: 100%;
        }

        .section_header span {
            vertical-align: middle;
        }

        .theme_light .section_header {
            color: #345;
        }

        .theme_dark .section_header {
            color: #BCD;
        }

        .divider {
            width: 100%;
            height: 1px;
            margin: 1.2em 0;
        }

        .theme_light .divider {
            background-color: #DDD;
        }

        .theme_dark .divider {
            background-color: #567;
        }

        #new_save {
            font-size: 80%;
            display: inline-block;
            float: right;
            padding: .1em .3em;
        }

        .modal {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            height: 100vh;
            width: 100vw;
            background-color: rgba(0, 0, 0, .5);
            z-index: 2;
        }

        .theme_light .modal {
            color: #345;
        }

        .theme_dark .modal {
            color: #FFF;
        }

        .modal.active {
            display: block;
        }

        .modal > table {
            height: 100%;
            width: 100%;
        }

        .modal td {
            padding: 0;
        }

        .modal td > div {
            height: 20em;
            min-height: 60vh;
            max-height: 95vh;
            width: 50em;
            min-width: 70vw;
            max-width: 95vw;
            border-radius: .25em;
            margin: auto;
        }

        .theme_light .modal td > div {
            background-color: #FFF;
        }

        .theme_dark .modal td > div {
            background-color: #234;
        }

        .modal_header {
            margin: 0 1em;
            padding: .5em 0 .4em;
            font-size: 1.25em;
            border-bottom-width: 1px;
            border-bottom-style: solid;
            line-height: 1.2;
        }

        .theme_light .modal_header {
            border-bottom-color: #DDD;
        }

        .theme_dark .modal_header {
            border-bottom-color: #567;
        }

        .modal_body {
            height: calc(100% - 5.35em - 4px);
            margin: 0 1.25em;
            padding: .5em 0;
            overflow-y: auto;
            overflow-x: hidden;
            display: table;
            width: calc(100% - 2.5em);
        }

        .modal_body > div {
            display: table-cell;
            vertical-align: middle;
        }

        .modal_footer {
            margin: 0 1em;
            padding: .5em 0 .4em;
            font-size: 1.25em;
            border-top-width: 1px;
            border-top-style: solid;
            text-align: right;
        }

        .theme_light .modal_footer {
            border-top-color: #DDD;
        }

        .theme_dark .modal_footer {
            border-top-color: #567;
        }

        .modal_footer button {
            font-size: .8em;
            padding: .2em .4em;
            line-height: 1.2;
        }

        input {
            border-width: 1px;
            border-style: solid;
            padding: .5em .8em;
            border-radius: .4em;
            font-size: 1em;
        }

        .theme_light input {
            background-color: #F0F0F0;
            border-color: #DDD;
            color: #345;
        }

        .theme_dark input {
            background-color: #456;
            border-color: #567;
            color: #FFF;
        }

        #save_name_error {
            display: none;
            text-align: center;
            font-family: Philosopher, sans-serif;
            font-size: 1.1em;
            padding: .2em 0 0;
        }

        #save_input_text {
            text-align: center;
            font-family: Philosopher, sans-serif;
            font-size: 1.1em;
            padding: 1.5em 0 .2em;
        }

        #save_name {
            width: 40em;
            min-width: calc(40vw - 4.1em - 2px);
            max-width: calc(95vw - 4.1em - 2px);
            margin: auto;
            text-align: center;
            display: block;
            font-family: inherit;
        }

        .theme_light #save_name.invalid {
            color: #F00;
        }

        .theme_dark #save_name.invalid {
            color: #FF4D4D;
        }

        #save_input {
            border-width: 1px;
            border-style: solid;
            padding: .5em .8em;
            border-radius: .4em;
            width: 40em;
            min-width: calc(40vw - 4.1em - 2px);
            max-width: calc(95vw - 4.1em - 2px);
            margin: auto;
            text-align: center;
            display: block;
            font-family: "Share Tech Mono", Consolas, Monaco, Andale Mono, "Courier New", Courier, monospace;
        }

        #save_stats {
            font-family: Philosopher, sans-serif;
            text-align: center;
            padding: 1em 0 0;
        }

        .save {
            border-bottom-style: solid;
            border-bottom-width: 1px;
            margin: 0;
            padding: .3em 0;
            display: flex;
            align-items: center;
        }

        .save:last-child {
            border-width: 0;
        }

        .theme_light .save {
            border-color: #DDD;
        }

        .theme_dark .save {
            border-color: #567;
        }

        .save:first-child {
            border-top-width: 0;
        }

        .save .name {
            display: inline-block;
            white-space: nowrap;
            flex-grow: 1;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            font-size: 1.1em;
        }

        .save .name div {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .theme_light .save .name {
            color: #345;
        }

        .theme_dark .save .name {
            color: #FFF;
        }

        .save_stats {
            font-size: .875em;
            font-family: Philosopher, sans-serif;
        }

        .theme_light .save_stats {
            color: #999;
        }

        .theme_dark .save_stats {
            color: #789;
        }

        .save .roll_btn {
            padding: .3em .5em;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            line-height: 1.2;
            font-size: 1.1em;
        }

        .save .extra_menu {
            padding: .3em;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            margin-left: -1px;
            line-height: 1.2;
            font-family: Philosopher, sans-serif;
            font-size: 1.1em;
        }

        .save .roll_btn:hover,
        .save .roll_btn:focus,
        .save .roll_btn:active,
        .save .extra_menu:hover,
        .save .extra_menu:focus,
        .save .extra_menu:active {
            z-index: 1;
        }

        .save .context_menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            min-width: calc(100% + 3em + 1px);
            margin-bottom: 1.5em;
        }

        .save .context_menu button {
            border-width: 0;
            width: 100%;
            white-space: nowrap;
            border-radius: 0;
        }

        .save .extra_menu:focus-within:not(:focus) {
            z-index: 2;
        }

        .save .extra_menu:focus-within:not(:focus) .context_menu {
            display: block;
        }

        #slider_x {
            display: block;
            position: absolute;
            top: 0;
            left: calc(50% - .2em - .5px);
            width: .4em;
            height: 100%;
            cursor: ew-resize;
            z-index: 1;
        }

        #slider_y {
            display: none;
        }

        #history #hist_header {
            float: right;
            text-align: right;
            margin-right: .5em;
            padding: 0;
            margin-bottom: .3em;
        }

        #history #clear_history,
        #modal_stats {
            background-color: transparent;
            color: inherit;
            border-width: 0;
            padding: 0;
            font-size: .9em;
            font-family: Philosopher, sans-serif;
        }

        #history #clear_history:hover,
        #history #clear_history:focus,
        #modal_stats:hover,
        #modal_stats:focus {
            text-decoration: underline;
        }

        #settings {
            padding: 0;
            line-height: 0;
            vertical-align: middle;
        }

        #settings img {
            width: 1em;
            padding: .1em;
        }

        #theme_prev {
            font-family: "Share Tech Mono", Consolas, Monaco, Andale Mono, "Courier New", Courier, monospace;
            border-radius: .5em;
            border-width: 1px;
            border-style: solid;
            padding: .3em 0;
            font-size: 1.1em;
        }

        #theme_prev > div {
            width: calc(100% - 1em);
            padding: .1em .5em;
        }

        #prefs_modal_select {
            display: block;
            padding: .3em .5em;
            margin: .3em auto 1em;
        }

        option {
            font-family: Philosopher, sans-serif
        }

        #license {
            font-family: Philosopher, sans-serif;
            font-size: .8em;
            padding: .3em 0;
            text-align: right;
        }

        .hist_stats_link {
            position: absolute;
            right: .5em;
            bottom: .3125em;
            font-family: Philosopher, sans-serif;
            font-size: .8em;
            font-style: italic;
        }

        .hist_stats_link a {
            color: inherit;
            text-decoration: none;
        }

        .hist_stats_link a:hover {
            text-decoration: underline;
        }

        #modal_stats {
            display: block;
            margin: auto;
            font-style: italic;
        }

        #modal_stats[disabled] {
            visibility: hidden;
        }

        .theme_light #modal_stats {
            color: #2196F3;
        }

        .theme_dark #modal_stats {
            color: #4FC3F7;
        }

        @media (max-aspect-ratio: 1/1) {
            #main {
                flex-direction: column;
            }

            #left {
                width: calc(100% - 2em);
                height: calc(50% - 3em);
            }

            #right {
                width: 100%;
                height: 50%;
            }

            #history {
                height: calc(100% - 2.35em - 1px);
                max-height: initial;
            }

            #custom {
                height: 1.15em;
                min-height: initial;
            }

            #customContainer {
                height: auto;
                min-height: 1.55em;
                min-height: initial;
                position: absolute;
                bottom: 0;
            }

            #slider_x {
                display: none;
            }

            #slider_y {
                display: block;
                position: absolute;
                top: calc(50vh - 1vh - .5px);
                left: 0;
                height: 2vh;
                width: 100%;
                cursor: ns-resize;
                z-index: 1;
            }
        }
    </style>
    <script type='text/javascript' src='dieroller.js'></script>
    <script type='text/javascript' src='syntax.js'></script>
</head>
<body>
    <div id='main'>
        <div id='left'>
            <div class='section_header'>
                <span>Quick Rolls</span>
            </div>
            <!--
                The next element (#general_rolls) is split like this:
                [[[d2, d4], [d6, d8]], [[d10, d12], [d20, d100]]]
                That lets it wrap only at places where the table will be one of these dimensions:
                1x8, 2x4, 4x2, 8x1
                Which means there won't ever be an empty cell on a line
             -->
            <div id='general_rolls' class='roll_flex'>
                <div class='roll_flex'>
                    <div class='roll_flex'>
                        <button id='d2_btn' class='roll_btn'>d2</button>
                        <button id='d4_btn' class='roll_btn'>d4</button>
                    </div>
                    <div class='roll_flex'>
                        <button id='d6_btn' class='roll_btn'>d6</button>
                        <button id='d8_btn' class='roll_btn'>d8</button>
                    </div>
                </div>
                <div class='roll_flex'>
                    <div class='roll_flex'>
                        <button id='d10_btn' class='roll_btn'>d10</button>
                        <button id='d12_btn' class='roll_btn'>d12</button>
                    </div>
                    <div class='roll_flex'>
                        <button id='d20_btn' class='roll_btn'>d20</button>
                        <button id='d100_btn' class='roll_btn'>d100</button>
                    </div>
                </div>
            </div>
            <div class='divider'></div>
            <div class='section_header'>
                <span>Saved Rolls</span>
                <button id='new_save'>+ New</button>
            </div>
            <div id='saves_container'></div>
        </div>
        <div id='slider_x'></div>
        <div id='slider_y'></div>
        <div id='right'>
            <div id='history'>
                <div id='hist_header'>
                    <button id='clear_history'>Clear History</button>
                    <button id='settings'><img src='settings_light.svg'></button>
                </div>
            </div>
            <div id='customContainer'>
                <div id='inputSymbol'>
                    <div>&#155;</div>
                </div>
                <div id='custom' contenteditable='true' spellcheck='false'></div>
            </div>
        </div>
        <div id='save_modal' class='modal'>
            <table>
                <td>
                    <div id='save_modal_window'>
                        <div class='modal_header'>
                            <span>Create/Edit Saved Rolls</span>
                        </div>
                        <div class='modal_body'>
                            <div>
                                <input id='save_name' placeholder='Name'>
                                <div id='save_name_error'></div>
                                <div id='save_input_text'>Enter a text definition for what to roll for.</div>
                                <div id='save_input' contenteditable='true' specllcheck='false'></div>
                                <div id='save_stats'></div>
                                <button id='modal_stats'>More statistics</button>
                            </div>
                        </div>
                        <div class='modal_footer'>
                            <button id='save_modal_cancel'>Cancel</button>
                            <button id='save_modal_save' class='main'>Save</button>
                        </div>
                    </div>
                </td>
            </table>
        </div>
        <div id='prefs_modal' class='modal'>
            <table>
                <td>
                    <div id='prefs_modal_window'>
                        <div class='modal_header'>
                            <span>Change Color Scheme</span>
                        </div>
                        <div class='modal_body'>
                            <div>
                                <select id='prefs_modal_select'>
                                    <option value="Alabaster">Alabaster</option>
                                    <option value="Atom Dark">Atom One (Dark)</option>
                                    <option value="Atom Light">Atom One (Light)</option>
                                    <option value="Cobalt">Cobalt</option>
                                    <option value="Dracula">Dracula</option>
                                    <option value="Material Dark">Material (Dark)</option>
                                    <option value="Material Light">Material (Light)</option>
                                    <option value="Monokai">Monokai</option>
                                    <option value="Solarized Dark">Solarized (Dark)</option>
                                    <option value="Solarized Light">Solarized (Light)</option>
                                    <option value="Verdandi Light">Verdandi</option>
                                    <option value="Verdandi Dark"> Verdandi Alter</option>
                                </select>
                                <div id='theme_prev'></div>
                                <div id='license'>Color schemes licensed under the MIT license.</div>
                            </div>
                        </div>
                        <div class='modal_footer'>
                            <button id='prefs_modal_cancel'>Cancel</button>
                            <button id='prefs_modal_save' class='main'>Save</button>
                        </div>
                    </div>
                </td>
            </table>
        </div>
    </div>
    <script type='text/javascript'>
        !function() {
            "use strict";
            var historyDiv = document.getElementById("history"),
                customInput = document.getElementById("custom"),
                saveModal = document.getElementById("save_modal"),
                saveModalSaveBtn = document.getElementById("save_modal_save"),
                saveModalName = document.getElementById("save_name"),
                saveModalNameError = document.getElementById("save_name_error"),
                saveModalInput = document.getElementById("save_input"),
                saveModalStats = document.getElementById("save_stats"),
                saveModalMoreStats = document.getElementById("modal_stats"),
                savesContainer = document.getElementById("saves_container"),
                sliderX = document.getElementById("slider_x"),
                sliderY = document.getElementById("slider_y"),
                left = document.getElementById("left"),
                right = document.getElementById("right"),
                prefsModal = document.getElementById("prefs_modal"),
                prefsModalSelect = document.getElementById("prefs_modal_select"),
                prefsModalPreview = document.getElementById("theme_prev"),
                clearHistory = document.getElementById("clear_history"),
                pastEntries = [],
                currentEntry = 0;

            // Here, some styles are set up according to the current theme.
            document.body.className = "theme_" + (dieroller.theme.type || "light");
            historyDiv.style.backgroundColor = dieroller.theme.background || "";
            historyDiv.style.color = dieroller.theme.text || "";
            customInput.style.backgroundColor = dieroller.theme.background || "";
            saveModalInput.style.backgroundColor = dieroller.theme.background || "";
            clearHistory.style.color = dieroller.theme.link || "";
            saveModalInput.style.borderColor = dieroller.theme.separator || "";
            customInput.style.color = dieroller.theme.text || "";
            document.getElementById("settings").firstElementChild.src = "settings_" + dieroller.theme.type + ".svg";
            document.getElementById("inputSymbol").style.color = dieroller.theme.arrow || "";
            document.getElementById("customContainer").style.borderColor = dieroller.theme.separator || "";

            [2,4,6,8,10,12,20,100].forEach(function(dn, i, arr) {
                var button = document.getElementById("d" + dn + "_btn");
                button.addEventListener("click", function() {
                    var result = dieroller.eval(syntax.parse("d" + dn));

                    var div = document.createElement('div'),
                        answer = document.createElement("div"),
                        stats = document.createElement("div");
                    answer.appendChild(document.createTextNode("= " + result));
                    div.appendChild(syntax.render(syntax.parse("1d" + dn)));
                    div.appendChild(document.createElement("br"));
                    div.appendChild(answer);
                    stats.innerHTML = "<a href='/dice/stats#1d" + dn + "' target='_blank'>Statistics</a>";
                    stats.className = "hist_stats_link";
                    stats.style.color = dieroller.theme.link || "";
                    div.appendChild(stats);

                    div.addEventListener("mouseenter", function() {
                        this.style.backgroundColor = dieroller.theme.hover || "";
                    });
                    div.addEventListener("mouseleave", function() {
                        this.style.backgroundColor = "";
                    });


                    historyDiv.insertBefore(div, historyDiv.firstElementChild.nextElementSibling);
                });
                button.addEventListener("keydown", function(e) {
                    if (e.key == "ArrowDown" || e.key == "ArrowRight" || e.keyCode == 40 || e.keyCode == 39) {
                        document.getElementById("d" + (arr[i + 1] || arr[0]) + "_btn").focus();
                    } else if (e.key == "ArrowUp" || e.key == "ArrowLeft" || e.keyCode == 38 || e.keyCode == 37) {
                        document.getElementById("d" + (arr[i - 1] || arr[7]) + "_btn").focus();
                    }
                });
            });

            // Now, a bunch of event listeners for buttons and stuff
            saveModalMoreStats.addEventListener("click", function() {
                if (this.disabled) return;
                window.open("/dice/stats#" + encodeURIComponent(saveModalInput.innerText.replace(/\s+/g, " ")));
            });
            prefsModalSelect.addEventListener("change", function() {
                var oldTheme = dieroller.theme.name;
                dieroller.theme = dieroller.themes[this.value];
                prefsModalPreview.innerHTML = "";
                prefsModalPreview.style.backgroundColor = dieroller.theme.background || "";
                prefsModalPreview.style.color = dieroller.theme.text || "";
                prefsModalPreview.style.borderColor = dieroller.theme.separator || "";
                dieroller.savedRolls['nameOfASavedRoll'] = dieroller.savedRolls['nameOfASavedRoll'] || null;
                dieroller.savedRolls['Name\u00A0of\u00A0Another\u00A0Roll'] = dieroller.savedRolls['Name\u00A0of\u00A0Another\u00A0Roll'] || null;
                prefsModalPreview.appendChild(syntax.render(syntax.parse("2 * (2d8 + 4d6) + d8")));
                prefsModalPreview.appendChild(document.createElement("br"));
                prefsModalPreview.appendChild(syntax.render(syntax.parse("max(keepLowest(2d8), dropHighest(4d4))")));
                prefsModalPreview.appendChild(document.createElement("br"));
                prefsModalPreview.appendChild(syntax.render(syntax.parse("(1 + (2 - 3)) * 4 / 5 % 6")));
                prefsModalPreview.appendChild(document.createElement("br"));
                prefsModalPreview.appendChild(syntax.render(syntax.parse("nameOfASavedRoll * Name of Another Roll")));
                prefsModalPreview.appendChild(document.createElement("br"));
                var invalid = document.createElement("div"),
                    invalid_text = document.createElement("div");
                invalid.style.display = invalid_text.style.display = "inline-block";
                for (var style in dieroller.theme.invalid) {
                    invalid_text.style[style] = dieroller.theme.invalid[style];
                }
                invalid_text.appendChild(document.createTextNode("Red Highlighted (Invalid) Text"));
                invalid.appendChild(invalid_text);
                prefsModalPreview.appendChild(invalid);
                prefsModalPreview.appendChild(document.createElement("br"));
                var answer = document.createElement("div");
                answer.style.color = dieroller.theme.text || "";
                answer.appendChild(document.createTextNode("= An Answer"));
                prefsModalPreview.appendChild(answer);
                if (dieroller.savedRolls['nameOfASavedRoll'] === null) delete dieroller.savedRolls['nameOfASavedRoll'];
                if (dieroller.savedRolls['Name\u00A0of\u00A0Another\u00A0Roll'] === null) delete dieroller.savedRolls['Name\u00A0of\u00A0Another\u00A0Roll'];
                var hoverColor = dieroller.theme.hover || "";
                for (var i = prefsModalPreview.children.length - 1; i >= 0; i--) {
                    prefsModalPreview.children[i].addEventListener("mouseenter", function() {
                        this.style.backgroundColor = hoverColor;
                    });
                    prefsModalPreview.children[i].addEventListener("mouseleave", function() {
                        this.style.backgroundColor = "";
                    });
                }
                dieroller.theme = dieroller.themes[oldTheme];
            });
            document.getElementById("prefs_modal_save").addEventListener("click", function() {
                dieroller.theme = dieroller.themes[prefsModalSelect.value];
                document.body.className = "theme_" + (dieroller.theme.type || "light");
                historyDiv.style.backgroundColor = dieroller.theme.background || "";
                historyDiv.style.color = dieroller.theme.text || "";
                customInput.style.backgroundColor = dieroller.theme.background || "";
                saveModalInput.style.backgroundColor = dieroller.theme.background || "";
                saveModalInput.style.borderColor = dieroller.theme.separator || "";
                clearHistory.style.color = dieroller.theme.link || "";
                customInput.style.color = dieroller.theme.text || "";
                document.getElementById("settings").firstElementChild.src = "settings_" + dieroller.theme.type + ".svg";
                document.getElementById("inputSymbol").style.color = dieroller.theme.arrow || "";
                document.getElementById("customContainer").style.borderColor = dieroller.theme.separator || "";
                for (var i = historyDiv.children.length - 1; i >= 1; i--) {
                    var div = historyDiv.children[i].firstElementChild.originalTokens ? historyDiv.children[i].firstElementChild : historyDiv.children[i].children[1];
                    div.parentNode.insertBefore(syntax.render(div.originalTokens), div);
                    div.parentNode.removeChild(div);
                    historyDiv.children[i].lastElementChild.style.color = dieroller.theme.link || "";
                }
                localStorage["die_roll_theme"] = prefsModalSelect.value;
                prefsModal.className = "modal";
            });
            document.getElementById("prefs_modal_window").addEventListener("click", function(e) {
                e.stopPropagation();
            });
            prefsModal.addEventListener("click", function() {
                this.className = "modal";
            });
            document.getElementById("prefs_modal_cancel").addEventListener("click", function() {
                prefsModal.className = "modal";
            });
            document.getElementById("settings").addEventListener("click", function() {
                prefsModalSelect.value = dieroller.theme.name;
                prefsModalSelect.dispatchEvent(new Event("change"));
                prefsModal.className = "modal active";
            });
            document.addEventListener("mousemove", function(e) {
                if (sliderX.activated) {
                    var percent = Math.max(15, Math.min(85, Math.round(e.clientX / window.innerWidth * 10000) / 100));
                    sliderX.style.left = "calc(" + percent + "% - 0.2em - 0.5px)";
                    left.style.width = "calc(" + percent + "% - 2em)";
                    left.style.height = "";
                    right.style.width = 100 - percent + "%";
                    right.style.height = "";
                    document.getSelection().removeAllRanges();
                } else if (sliderY.activated) {
                    var percent = Math.max(15, Math.min(85, Math.round(e.clientY / window.innerHeight * 10000) / 100));
                    sliderY.style.top = "calc(" + percent - 1 + "vh - 0.5px)";
                    left.style.height = "calc(" + percent + "vh - 3em)";
                    left.style.width = "";
                    right.style.height = 100 - percent + "vh";
                    right.style.width = "";
                    document.getSelection().removeAllRanges();
                }
            });
            document.addEventListener("touchmove", function(e) {
                if (sliderX.activated) {
                    var percent = Math.max(15, Math.min(85, Math.round(e.touches[0].clientX/ window.innerWidth * 10000) / 100));
                    sliderX.style.left = "calc(" + percent + "% - 0.2em - 0.5px)";
                    left.style.width = "calc(" + percent + "% - 2em)";
                    left.style.height = "";
                    right.style.width = 100 - percent + "%";
                    right.style.height = "";
                    document.getSelection().removeAllRanges();
                } else if (sliderY.activated) {
                    e.stopPropagation();
                    e.preventDefault();
                    var percent = Math.max(15, Math.min(85, Math.round(e.touches[0].clientY / window.innerHeight * 10000) / 100));
                    sliderY.style.top = "calc(" + (percent - 1) + "vh - 0.5px)";
                    left.style.height = "calc(" + percent + "vh - 3em)";
                    left.style.width = "";
                    right.style.height = 100 - percent + "vh";
                    right.style.width = "";
                    document.getSelection().removeAllRanges();
                }
            });
            window.addEventListener("resize", function() {
                if (window.innerHeight >= window.innerWidth) {
                    left.style.width = "";
                    right.style.width = "";
                    sliderX.style.left = "";
                } else {
                    left.style.height = "";
                    right.style.height = "";
                    sliderY.style.top = "";
                }
            });
            sliderX.addEventListener("mousedown", function() {
                this.activated = true;
            });
            sliderX.addEventListener("touchstart", function() {
                this.activated = true;
            });
            sliderY.addEventListener("mousedown", function() {
                this.activated = true;
            });
            sliderY.addEventListener("touchstart", function() {
                this.activated = true;
            });
            document.addEventListener("mouseup", function() {
                sliderX.activated = false;
                sliderY.activated = false;
            });
            document.addEventListener("touchend", function() {
                sliderX.activated = false;
                sliderY.activated = false;
            })
            clearHistory.addEventListener("click", function() {
                while (historyDiv.firstElementChild != historyDiv.lastElementChild) {
                    historyDiv.removeChild(historyDiv.lastElementChild);
                }
            });
            saveModalSaveBtn.addEventListener("click", function() {
                if (this.disabled) return;
                if (saveModal.editing) {
                    delete dieroller.savedRolls[saveModal.editing];
                }
                dieroller.savedRolls[saveModalName.value.replace(/\s+/g, "\u00A0").trim()] = syntax.reform(syntax.parse(saveModalInput.innerText.replace(/ /g, "\u00A0")));
                localStorage["saved_die_rolls"] = JSON.stringify(dieroller.savedRolls);
                updateSaves();
                saveModal.className = "modal";
            });
            saveModalInput.addEventListener("keydown", function(e) {
                if (e.key == "Enter" || e.keyCode == 13) {
                    e.preventDefault();
                    saveModalSaveBtn.click();
                }
            });
            saveModalInput.addEventListener("input", function() {
                var selection = document.getSelection();
                this.selectionDirection = "forward";

                if (!this.innerText || !this.firstChild || this.firstChild.nodeName == "BR") {
                    this.selectionStart = this.selectionEnd = 0;
                } else if (selection.anchorNode.parentNode == this) {
                    this.selectionStart = this.selectionEnd = selection.anchorOffset;
                } else {
                    var anchorOffset = selection.anchorOffset,
                        anchorNode = selection.anchorNode;

                    // Contenteditable <divs> kind of screw things up because they add <font> elements
                    // inside other elements instead of following the existing pattern.
                    if (anchorNode.parentNode.parentNode.parentNode == this) {
                        anchorNode.parentNode.parentNode.insertBefore(anchorNode, anchorNode.parentNode);
                        anchorNode.parentNode.removeChild(anchorNode.nextSibling);
                    }

                    while (anchorNode.parentNode.firstChild != anchorNode) {
                        anchorOffset += anchorNode.previousSibling.data.length;
                        anchorNode.data = anchorNode.previousSibling.data + anchorNode.data;
                        anchorNode.parentNode.removeChild(anchorNode.previousSibling);
                    }

                    anchorNode = selection.anchorNode;
                    if (anchorNode.nodeName == "SPAN") anchorNode = anchorNode.firstChild;

                    var totalOffset = 0;
                    for (var i = Array.prototype.indexOf.call(this.children, anchorNode.parentNode) - 1; i >= 0; i--) {
                        totalOffset += this.children[i].innerText.length;
                    }
                    this.selectionStart = this.selectionEnd = totalOffset + anchorOffset;
                }

                this.value = this.innerText.replace(/ /g, "\u00A0").replace(/\n/g, "");

                var oldCharLength = parseInt(this.style.width.substring(12)),
                    newCharLength = Math.max.apply(Math, this.value.split("\n").map(function(line) {
                    return line.length;
                }));

                this.innerText = "";
                var roll = syntax.parse(this.value),
                    renderedText = syntax.render(roll);
                while (renderedText.firstChild) {
                    this.appendChild(renderedText.firstChild);
                }

                var range = document.createRange();
                if (!this.firstChild) {
                    this.appendChild(document.createTextNode(""));
                    range.setStart(this.firstChild, 0);
                    range.setEnd(this.firstChild, 0);
                } else {
                    for (var i = 0, offset = 0; i < this.children.length && offset + this.children[i].innerText.length < this.selectionStart; offset += this.children[i++].innerText.length) {}
                    range.setStart(this.children[i].firstChild, this.selectionStart - offset);
                    for (var i = 0, offset = 0; offset + this.children[i].innerText.length < this.selectionEnd && i < this.children.length; offset += this.children[i++].innerText.length) {}
                    range.setEnd(this.children[i].firstChild, this.selectionEnd - offset);
                }
                selection.removeAllRanges();
                selection.addRange(range);


                var namedRolls = Object.keys(dieroller.savedRolls).sort(function(a, b) {
                    return a.length > b.length;
                }), normalizedName = saveModalName.value.replace(/\s+/g, "\u00A0").trim();
                // This function checks to make sure a definition doesn't result in a recursive
                // loop (i.e. it checks if its definition expands to itself).
                function checkExpand(name, arr, tokens) {
                    name = name.replace(/\s+/g, "\u00A0").trim();
                    if (~arr.indexOf(name.toLowerCase())) return true;
                    arr = arr.slice();
                    arr.push(name.toLowerCase());
                    if (!dieroller.savedRolls[normalizedName]) {
                        dieroller.savedRolls[normalizedName] = null;
                    }
                    var tokens = tokens || syntax.parse(dieroller.savedRolls[name]);
                    if (!tokens) {
                        for (var i = namedRolls.length - 1; i >= 0; i--) {
                            if (namedRolls[i].toLowerCase() == name.toLowerCase()) {
                                tokens = syntax.parse(dieroller.savedRolls[namedRolls[i]]);
                                break;
                            }
                        }
                    }
                    if (dieroller.savedRolls[normalizedName] === null) {
                        delete dieroller.savedRolls[normalizedName];
                    }
                    for (var i = 0, l = tokens.length; i < l; i++) {
                        if (tokens[i].type == "named") {
                            var result = checkExpand(tokens[i].value, arr);
                            if (result) return result;
                        }
                    }
                }

                if (roll.invalid) {
                    saveModalStats.innerText = "The definition contains errors."
                    saveModalSaveBtn.disabled = true;
                    saveModalMoreStats.disabled = true;
                    this.isInvalid = true;
                } else if (!roll.length || roll.every(function(token) {
                    return token.type == "whitespace";
                })) {
                    saveModalStats.innerText = "The definition cannot be empty."
                    saveModalSaveBtn.disabled = true;
                    saveModalMoreStats.disabled = true;
                    this.isInvalid = true;
                } else if (checkExpand(saveModalName.value, [], syntax.parse(this.value))) {
                    saveModalStats.innerText = "The definition cannot cycle back to itself."
                    saveModalSaveBtn.disabled = true;
                    saveModalMoreStats.disabled = true;
                    this.isInvalid = true;
                } else {
                    var min = dieroller.min(roll), max = dieroller.max(roll);
                    saveModalStats.innerHTML = "Minimum: " + min + ", Midrange: " + (+min + +max) / 2 + ", Maximum: " + max;
                    saveModalSaveBtn.disabled = saveModalName.isInvalid;
                    saveModalMoreStats.disabled = false;
                    this.isInvalid = false;
                }
            });
            saveModalName.addEventListener("keydown", function(e) {
                if (e.key == "Enter" || e.keyCode == 13) {
                    var selection = document.getSelection(),
                        range = document.createRange();
                    if (saveModalInput.lastElementChild) {
                        if (saveModalInput.lastElementChild.lastChild) {
                            range.setStart(saveModalInput.lastElementChild.lastChild, saveModalInput.lastElementChild.lastChild.data.length);
                            range.setEnd(saveModalInput.lastElementChild.lastChild, saveModalInput.lastElementChild.lastChild.data.length)
                        } else {
                            saveModalInput.lastElementChild.appendChild(document.createTextNode(""));
                            range.setStart(saveModalInput.lastElementChild.lastChild, 0);
                            range.setEnd(saveModalInput.lastElementChild.lastChild, 0);
                        }
                    } else {
                        saveModalInput.appendChild(document.createTextNode(""));
                        range.setStart(saveModalInput.lastChild, 0);
                        range.setEnd(saveModalInput.lastChild, 0);
                    }
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            });
            saveModalName.addEventListener("input", function() {
                var normalizedNamed = this.value.trim().replace(/\s+/g, "\u00A0");
                // Some names can't be used. Names that are already being taken obviously can't be-
                // cause a name can only refer to one roll. But the name also can't look to close
                // to a die roll. For example, a name like "d20" isn't allowed because whenever a
                // d20 is rolled, that definition will be called instead of actually rolling a d20.
                // To test if the name is too similar, it's parsed as a die roll string. If it does
                // not return invalid, the string is is too close and the name is invalid.
                var rolls = dieroller.savedRolls;
                dieroller.savedRolls = {};
                var parsed = syntax.parse(normalizedNamed);
                dieroller.savedRolls = rolls;

                if (!normalizedNamed) {
                    this.className = "invalid";
                    saveModalSaveBtn.disabled = true;
                    saveModalNameError.style.display = "block";
                    saveModalNameError.innerText = "The name can't be empty.";
                    this.isInvalid = true;
                } else if (normalizedNamed in dieroller.savedRolls && saveModal.editing != normalizedNamed) {
                    this.className = "invalid";
                    saveModalSaveBtn.disabled = true;
                    saveModalNameError.style.display = "block";
                    saveModalNameError.innerText = "That name is already being used.";
                    this.isInvalid = true;
                } else if (!parsed.invalid) {
                    this.className = "invalid";
                    saveModalSaveBtn.disabled = true;
                    saveModalNameError.style.display = "block";
                    saveModalNameError.innerText = "That name is too close to a regular die roll.";
                    this.isInvalid = true;
                } else {
                    this.className = "";
                    saveModalSaveBtn.disabled = saveModalInput.isInvalid;
                    saveModalNameError.style.display = "";
                    this.isInvalid = false;
                }
            });
            document.addEventListener("keydown", function(e) {
                if (e.key == "Escape" || e.keyCode == 27) {
                    (document.querySelector(".modal.active") || {}).className = "modal";
                }
            });
            document.getElementById("save_modal_cancel").addEventListener("click", function() {
                saveModal.className = "modal";
            });
            document.getElementById("new_save").addEventListener("click", function() {
                saveModalName.value = "Roll " + (Object.keys(dieroller.savedRolls).length + 1);
                saveModalName.className = "";
                saveModalNameError.style.display = "";
                saveModalSaveBtn.disabled = false;
                saveModalMoreStats.disabled = false;
                saveModalInput.innerHTML = syntax.render(syntax.parse("1d20")).innerHTML;
                saveModalStats.innerText = "Minimum: 1, Midrange: 10.5, Maximum: 20";
                saveModal.editing = null;
                saveModal.className = "modal active";
                saveModalName.focus();
            });
            saveModal.addEventListener("click", function() {
                this.className = "modal";
            });
            document.getElementById("save_modal_window").addEventListener("click", function(e) {
                e.stopPropagation();
            });
            customInput.addEventListener("keydown", function(e) {
                if (e.key == "Enter" || e.keycode == 13) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.value = this.value || "";

                    var roll = syntax.parse(this.value.replace(/\t/g, "    ").replace(/\s/g, "\u00A0"));
                    if (this.value.trim()) {
                        pastEntries.push(this.innerHTML);
                        currentEntry = pastEntries.length;
                        var result = dieroller.eval(roll);
                        if (result == "inevaluable") return;
                        var unrounded = (Math.round(result * 10e7) / 10e7).toString();
                        result = isNaN(result) ? result : (Math.round(result * 10e6) / 10e6).toString();

                        var div = document.createElement('div'),
                            answer = document.createElement("div"),
                            stats = document.createElement("div");
                        answer.appendChild(document.createTextNode((unrounded == result ? "=" : "\u2248") + " " + result));
                        div.appendChild(syntax.render(syntax.normalize(roll)));
                        div.appendChild(document.createElement("br"));
                        div.appendChild(answer);
                        stats.innerHTML = "<a href='/dice/stats#" + encodeURIComponent(syntax.reform(roll).replace(/\s/g, " ")) + "' target='_blank'>Statistics</a>";
                        stats.className = "hist_stats_link";
                        stats.style.color = dieroller.theme.link || "";
                        div.appendChild(stats);

                        div.addEventListener("mouseenter", function() {
                            this.style.backgroundColor = dieroller.theme.hover || "";
                        });
                        div.addEventListener("mouseleave", function() {
                            this.style.backgroundColor = "";
                        });

                        historyDiv.insertBefore(div, historyDiv.firstElementChild.nextElementSibling);

                        this.innerText = "";
                        this.value = "";
                    }
                } else if ((e.key == "ArrowUp" || e.keyCode == 38) && currentEntry != 0) {
                    e.preventDefault();
                    e.stopPropagation();
                    currentEntry--;
                    this.innerHTML = pastEntries[currentEntry] || "";
                    this.value = this.innerText.replace(/\t/g, "    ").replace(/\s/g, "\u00A0");
                } else if ((e.key == "ArrowDown" || e.keyCode == 40) && currentEntry < pastEntries.length) {
                    e.preventDefault();
                    e.stopPropagation();
                    currentEntry++;
                    this.innerHTML = pastEntries[currentEntry] || "";
                    this.value = this.innerText.replace(/\t/g, "    ").replace(/\s/g, "\u00A0");
                }
            });
            customInput.addEventListener("input", function() {
                // The <input>'s width is set dynamically based on how many characters it has on
                // each of its lines.

                var selection = document.getSelection();
                this.selectionDirection = "forward";

                if (!this.innerText || !this.firstChild || this.firstChild.nodeName == "BR") {
                    this.selectionStart = this.selectionEnd = 0;
                } else if (selection.anchorNode.parentNode == this) {
                    this.selectionStart = this.selectionEnd = selection.anchorOffset;
                } else {
                    var anchorOffset = selection.anchorOffset,
                        anchorNode = selection.anchorNode;

                    // Contenteditable <divs> kind of screw things up because they add <font> elements
                    // inside other elements instead of following the existing pattern.
                    if (anchorNode.parentNode.parentNode.parentNode == this) {
                        anchorNode.parentNode.parentNode.insertBefore(anchorNode, anchorNode.parentNode);
                        anchorNode.parentNode.removeChild(anchorNode.nextSibling);
                    }

                    while (anchorNode.parentNode.firstChild != anchorNode) {
                        anchorOffset += anchorNode.previousSibling.data.length;
                        anchorNode.data = anchorNode.previousSibling.data + anchorNode.data;
                        anchorNode.parentNode.removeChild(anchorNode.previousSibling);
                    }

                    anchorNode = selection.anchorNode;
                    if (anchorNode.nodeName == "SPAN") anchorNode = anchorNode.firstChild;

                    var totalOffset = 0;
                    for (var i = Array.prototype.indexOf.call(this.children, anchorNode.parentNode) - 1; i >= 0; i--) {
                        totalOffset += this.children[i].innerText.length;
                    }
                    this.selectionStart = this.selectionEnd = totalOffset + anchorOffset;
                }

                this.value = this.innerText.replace(/ /g, "\u00A0");

                var oldCharLength = parseInt(this.style.width.substring(12)),
                    newCharLength = Math.max.apply(Math, this.value.split("\n").map(function(line) {
                    return line.length;
                }));
                this.style.width = "calc(.8em + " + (newCharLength - 1) + "ch)";
                if (newCharLength > oldCharLength && this.selectionEnd == newCharLength) this.parentNode.scrollLeft = this.scrollWidth;

                this.innerText = "";
                var renderedText = syntax.render(syntax.parse(this.value));
                while (renderedText.firstChild) {
                    this.appendChild(renderedText.firstChild);
                }

                var range = document.createRange();
                if (!this.firstChild) {
                    this.appendChild(document.createTextNode(""));
                    range.setStart(this.firstChild, 0);
                    range.setEnd(this.firstChild, 0);
                } else {
                    for (var i = 0, offset = 0; i < this.children.length && offset + this.children[i].innerText.length < this.selectionStart; offset += this.children[i++].innerText.length) {}
                    range.setStart(this.children[i].firstChild, this.selectionStart - offset);
                    for (var i = 0, offset = 0; offset + this.children[i].innerText.length < this.selectionEnd && i < this.children.length; offset += this.children[i++].innerText.length) {}
                    range.setEnd(this.children[i].firstChild, this.selectionEnd - offset);
                }
                selection.removeAllRanges();
                selection.addRange(range);
            });

            function updateSaves() {
                // This function updates the display of all the saved rolls you have.

                savesContainer.innerHTML = "";
                var names = Object.keys(dieroller.savedRolls).sort();

                for (var i = 0, l = names.length; i < l; i++) {
                    var div = document.createElement("div");
                    div.className = "save";
                    div.referName = names[i];
                    var nameContainer = document.createElement("div"),
                        name = document.createElement("div"),
                        stats = document.createElement("div");
                    nameContainer.className = "name";
                    name.innerText = names[i];
                    nameContainer.appendChild(name);
                    var min = dieroller.min(syntax.parse(dieroller.savedRolls[names[i]])),
                        max = dieroller.max(syntax.parse(dieroller.savedRolls[names[i]]));
                    stats.innerText = "Min " + min + ", Mid " + (+min + +max) / 2 + ", Max " + max;
                    stats.className = "save_stats";
                    nameContainer.appendChild(stats);
                    div.appendChild(nameContainer);
                    savesContainer.appendChild(div);
                    var roll = document.createElement("button");
                    roll.innerText = "Roll";
                    roll.className = "roll_btn";
                    roll.addEventListener("click", function() {
                        var roll = syntax.parse(dieroller.savedRolls[this.parentNode.referName]),
                            result = dieroller.eval(roll);

                        var div = document.createElement('div'),
                            rollingText = document.createElement("div"),
                            answer = document.createElement("div"),
                            stats = document.createElement("div");
                        rollingText.appendChild(document.createTextNode("Rolling " + this.parentNode.referName + ":"));
                        answer.appendChild(document.createTextNode("= " + result));
                        div.appendChild(rollingText);
                        div.appendChild(syntax.render(syntax.normalize(roll)));
                        div.appendChild(document.createElement("br"));
                        div.appendChild(answer);
                        stats.innerHTML = "<a href='/dice/stats#" + encodeURIComponent(syntax.reform(roll).replace(/\s/g, " ")) + "' target='_blank'>Statistics</a>";
                        stats.className = "hist_stats_link";
                        stats.style.color = dieroller.theme.link || "";
                        div.appendChild(stats);

                        div.addEventListener("mouseenter", function() {
                            this.style.backgroundColor = dieroller.theme.hover || "";
                        });
                        div.addEventListener("mouseleave", function() {
                            this.style.backgroundColor = "";
                        });

                        historyDiv.insertBefore(div, historyDiv.firstElementChild.nextElementSibling);
                    });
                    div.appendChild(roll);
                    roll.addEventListener("keydown", function(e) {
                        if (e.key == "ArrowRight" || e.key == 39) {
                            this.nextElementSibling.focus();
                            this.nextElementSibling.click();
                        } else if (e.key == "ArrowDown" || e.key == 40) {
                            (this.parentNode.nextElementSibling || this.parentNode.parentNode.firstElementChild).children[1].focus();
                        } else if (e.key == "ArrowUp" || e.key == 38) {
                            (this.parentNode.previousElementSibling || this.parentNode.parentNode.lastElementChild).children[1].focus();
                        }
                    });
                    var extra = document.createElement("button");
                    extra.innerText = "\u25BC";
                    extra.className = "extra_menu";
                    extra.addEventListener("keydown", function(e) {
                        if (e.key == "ArrowLeft" || e.key == 37) {
                            this.previousElementSibling.focus();
                        } else if (e.key == "ArrowDown" || e.key == 40) {
                            this.blur();
                            this.isExpanded = true;
                            this.lastElementChild.style.display = "block";
                            this.style.zIndex = 2;
                            this.firstElementChild.firstElementChild.focus();
                        } else if (e.key == "ArrowUp" || e.key == 38) {
                            this.blur();
                            this.isExpanded = true;
                            this.lastElementChild.style.display = "block";
                            this.style.zIndex = 2;
                            this.firstElementChild.lastElementChild.focus();
                        }
                    });
                    extra.addEventListener("click", function() {
                        if (document.activeElement == this.firstElementChild.firstElementChild ||
                            document.activeElement == this.firstElementChild.lastElementChild) {
                            this.isExpanded = true;
                        }
                        this.isExpanded = !this.isExpanded;
                        if (this.isExpanded) {
                            this.firstElementChild.style.display = "block";
                            this.style.zIndex = 2;
                        } else {
                            this.firstElementChild.style.display = "";
                            this.style.zIndex = "";
                        }
                    });
                    extra.addEventListener("blur", function() {
                        if (this.isExpanded || this.firstElementChild.style.display == "block") {
                            this.isExpanded = false;
                            this.lastElementChild.style.display = "";
                            this.style.zIndex = "";
                        }
                    });
                    div.appendChild(extra);
                    var menu = document.createElement("div");
                    menu.className = "context_menu";
                    var edit = document.createElement("button");
                    edit.innerText = "Edit";
                    edit.addEventListener("click", function(e) {
                        e.stopPropagation();
                        var name = this.parentNode.parentNode.parentNode.referName,
                            roll = syntax.parse(dieroller.savedRolls[name]);
                        saveModalName.value = name;
                        saveModalName.className = "";
                        saveModalNameError.style.display = "";
                        saveModalSaveBtn.disabled = false;
                        saveModalMoreStats.disabled = false;
                        saveModalInput.innerHTML = syntax.render(roll).innerHTML;
                        var min = dieroller.min(roll), max = dieroller.max(roll);
                        saveModalStats.innerText = "Minimum: " + min + ", Midrange: " + (+min + +max) / 2 + ", Maximum: " + max;
                        saveModal.editing = name;
                        saveModal.className = "modal active";
                        saveModalName.focus();
                    });
                    edit.addEventListener("keydown", function(e) {
                        if (e.key == "ArrowDown" || e.keyCode == 40) {
                            this.nextElementSibling.focus();
                            e.stopPropagation();
                        } else if (e.key == "ArrowUp" || e.keyCode == 38) {
                            this.parentNode.parentNode.focus();
                            e.stopPropagation();
                        }
                    });
                    edit.addEventListener("blur", function() {
                        this.parentNode.parentNode.dispatchEvent(new Event("blur"));
                    });
                    var del = document.createElement("button");
                    del.innerText = "Delete";
                    del.addEventListener("click", function(e) {
                        e.stopPropagation();
                        delete dieroller.savedRolls[this.parentNode.parentNode.parentNode.referName];
                        localStorage["saved_die_rolls"] = JSON.stringify(dieroller.savedRolls);
                        updateSaves();
                    });
                    del.addEventListener("keydown", function(e) {
                        if (e.key == "ArrowDown" || e.keyCode == 40) {
                            this.parentNode.parentNode.focus();
                            e.stopPropagation();
                        } else if (e.key == "ArrowUp" || e.keyCode == 38) {
                            this.previousElementSibling.focus();
                            e.stopPropagation();
                        }
                    });
                    del.addEventListener("blur", function() {
                        this.parentNode.parentNode.dispatchEvent(new Event("blur"));
                    });
                    menu.appendChild(edit);
                    menu.appendChild(del);
                    extra.appendChild(menu);
                }
            }

            updateSaves();
        }();
    </script>
</body>
</html>